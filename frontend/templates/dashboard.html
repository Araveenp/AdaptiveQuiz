{% extends "base.html" %}
{% block title %}Dashboard â€” AdaptiveQuiz{% endblock %}

{% block content %}
<div class="container fade-in">
    <!-- Welcome -->
    <div class="flex-between mb-3">
        <div>
            <h1>Welcome, {{ username }}! ğŸ‘‹</h1>
            <p class="text-secondary mt-1">{{ fun_fact }}</p>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('routes.study_hub') }}" class="btn btn-secondary">âš¡ Study Hub</a>
            <a href="#generate" class="btn btn-primary">ğŸ¯ New Quiz</a>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid-4 mb-3">
        <div class="glass stat-card">
            <div class="stat-value">{{ correct_total }}</div>
            <div class="stat-label">âœ… Correct Answers</div>
        </div>
        <div class="glass stat-card">
            <div class="stat-value">{{ incorrect_total }}</div>
            <div class="stat-label">âŒ Incorrect</div>
        </div>
        <div class="glass stat-card">
            <div class="stat-value">ğŸ”¥ {{ streak }}</div>
            <div class="stat-label">Day Streak</div>
        </div>
        <div class="glass stat-card">
            <div class="stat-value">{{ total_quizzes }}</div>
            <div class="stat-label">ğŸ“ Quizzes Taken</div>
        </div>
    </div>

    <div class="grid-2 mb-3">
        <!-- Topic Mastery -->
        <div class="glass">
            <h3 class="mb-2">ğŸ“ Topic Mastery</h3>
            {% if topic_mastery %}
                {% for m in topic_mastery %}
                <div class="mastery-item">
                    <div class="mastery-label">
                        <span>{{ m.topic }}</span>
                        <span class="text-secondary">{{ m.percentage }}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" style="width: {{ m.percentage }}%"></div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No topics mastered yet. Start a quiz to begin!</p>
            {% endif %}
        </div>

        <!-- Quick Actions -->
        <div class="glass">
            <h3 class="mb-2">âš¡ Quick Actions</h3>
            <div class="flex-col gap-2">
                <a href="{{ url_for('routes.study_hub') }}" class="btn btn-secondary" style="width:100%;">ğŸ“– Open Study Hub</a>
                {% if not is_guest %}
                <a href="{{ url_for('routes.review_mistakes') }}" class="btn btn-secondary" style="width:100%;">ğŸ” Review Mistakes ({{ mistake_count }})</a>
                <a href="{{ url_for('routes.library') }}" class="btn btn-secondary" style="width:100%;">ğŸ“š Quiz Library</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quiz Generator -->
    <div class="glass mb-3" id="generate">
        <h3 class="mb-2">ğŸ¯ Generate a New Quiz</h3>
        <p class="text-secondary mb-2">Choose your source and let AI create your assessment.</p>

        <!-- Source type tabs -->
        <div class="source-tabs">
            <button class="source-tab active" onclick="switchSource('topic')">ğŸ’¡ Topic</button>
            <button class="source-tab" onclick="switchSource('text')">ğŸ“ Text</button>
            <button class="source-tab" onclick="switchSource('pdf')">ğŸ“„ PDF</button>
            <button class="source-tab" onclick="switchSource('image')">ğŸ–¼ï¸ Image</button>
            {% if not is_guest %}
            <button class="source-tab" onclick="switchSource('mistake')">ğŸ”„ Mistake Bank</button>
            {% endif %}
        </div>

        <form method="POST" action="{{ url_for('routes.handle_generation') }}" enctype="multipart/form-data" id="quizForm">
            <input type="hidden" name="source_type" id="source_type" value="topic">

            <!-- Topic panel -->
            <div class="source-panel active" id="panel-topic">
                <div class="form-group">
                    <label class="form-label">Enter a Topic</label>
                    <input type="text" name="topic_name" class="form-control" placeholder="e.g. Machine Learning, Photosynthesis, World War II">
                </div>
            </div>

            <!-- Text panel -->
            <div class="source-panel" id="panel-text">
                <div class="form-group">
                    <label class="form-label">Paste Your Content</label>
                    <textarea name="raw_text" class="form-control" placeholder="Paste any study material, notes, or article text here..."></textarea>
                </div>
            </div>

            <!-- PDF panel -->
            <div class="source-panel" id="panel-pdf">
                <div class="form-group">
                    <label class="form-label">Upload PDF</label>
                    <input type="file" name="pdf_file" class="form-control" accept=".pdf">
                </div>
            </div>

            <!-- Image panel -->
            <div class="source-panel" id="panel-image">
                <div class="form-group">
                    <label class="form-label">Upload Image</label>
                    <input type="file" name="image_file" class="form-control" accept="image/*">
                </div>
            </div>

            <!-- Mistake panel -->
            <div class="source-panel" id="panel-mistake">
                <p class="text-secondary">Re-quiz yourself on questions you got wrong. AI will re-generate from your Mistake Bank.</p>
            </div>

            <!-- Options row -->
            <div class="grid-3 mt-2">
                <div class="form-group">
                    <label class="form-label">Questions</label>
                    <select name="count" class="form-control">
                        <option value="5">5 Questions</option>
                        <option value="10" selected>10 Questions</option>
                        <option value="15">15 Questions</option>
                        <option value="20">20 Questions</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Format</label>
                    <select name="q_format" class="form-control">
                        <option value="mcq">ğŸ“‹ Multiple Choice</option>
                        <option value="tf">âœ… True / False</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Difficulty</label>
                    <select name="difficulty" class="form-control">
                        <option value="easy">ğŸŸ¢ Easy</option>
                        <option value="medium" selected>ğŸŸ¡ Medium</option>
                        <option value="hard">ğŸ”´ Hard</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-lg" style="width:100%;">ğŸš€ Generate Quiz</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function switchSource(type) {
    document.querySelectorAll('.source-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.source-panel').forEach(p => p.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('panel-' + type).classList.add('active');
    document.getElementById('source_type').value = type;
}
</script>
{% endblock %}
